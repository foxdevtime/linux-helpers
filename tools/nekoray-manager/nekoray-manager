#!/bin/bash

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

INSTALL_DIR="/opt/nekoray"
BIN_LINK="/usr/local/bin/nekoray"
DESKTOP_FILE="/usr/share/applications/nekoray.desktop"
ICON_URL="https://raw.githubusercontent.com/MatsuriDayo/nekoray/main/res/icon.png"


check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo -e "${RED}Error: This operation requires Root privileges.${NC}"
        echo "Please run the script with sudo."
        exit 1
    fi
}

get_latest_url() {
    curl -s https://api.github.com/repos/MatsuriDayo/nekoray/releases/latest | \
    grep "browser_download_url.*linux-x64.AppImage" | \
    head -n 1 | \
    sed -E 's/.*"browser_download_url": "([^"]+)".*/\1/'
}

install_nekoray() {
    check_root
    echo -e "${BLUE}Fetching latest release info...${NC}"
    
    DOWNLOAD_URL=$(get_latest_url)
    if [ -z "$DOWNLOAD_URL" ]; then
        echo -e "${RED}Failed to find download URL. Check internet connection.${NC}"
        exit 1
    fi

    echo -e "Downloading from: ${YELLOW}$DOWNLOAD_URL${NC}"

    mkdir -p "$INSTALL_DIR"
    
    echo -e "${BLUE}Downloading AppImage...${NC}"
    if curl -L --progress-bar "$DOWNLOAD_URL" -o "$INSTALL_DIR/nekoray.AppImage"; then
        chmod +x "$INSTALL_DIR/nekoray.AppImage"
    else
        echo -e "${RED}Download failed!${NC}"
        exit 1
    fi

    echo -e "${BLUE}Downloading Icon...${NC}"
    curl -s -L "$ICON_URL" -o "$INSTALL_DIR/nekoray.png"

    echo -e "${BLUE}Creating global command 'nekoray'...${NC}"
    cat <<EOF > "$BIN_LINK"
#!/bin/bash
if [ "\$1" == "--tun" ]; then
    pkexec "$INSTALL_DIR/nekoray.AppImage" > /dev/null 2>&1 &
else
    "$INSTALL_DIR/nekoray.AppImage" "\$@" > /dev/null 2>&1 &
fi
disown
EOF
    chmod +x "$BIN_LINK"

    echo -e "${BLUE}Creating Desktop Entry...${NC}"
    cat <<EOF > "$DESKTOP_FILE"
[Desktop Entry]
Name=Nekoray
Comment=Qt based cross-platform GUI for sing-box
Exec=$INSTALL_DIR/nekoray.AppImage
Icon=$INSTALL_DIR/nekoray.png
Terminal=false
Type=Application
Categories=Network;
Actions=TunMode;

[Desktop Action TunMode]
Name=Run in TUN Mode (Root)
Exec=pkexec $INSTALL_DIR/nekoray.AppImage
EOF

    echo -e "${GREEN}Installation Complete!${NC}"
    echo -e "1. Run ${BOLD}nekoray${NC} in terminal (won't block terminal)."
    echo -e "2. Run ${BOLD}sudo nekoray${NC} for TUN mode."
    echo -e "3. Or find 'Nekoray' in your Application Menu."
}

uninstall_nekoray() {
    check_root
    echo -e "${YELLOW}Uninstalling Nekoray...${NC}"

    rm -rf "$INSTALL_DIR"
    echo -e "Removed $INSTALL_DIR"

    rm -f "$BIN_LINK"
    echo -e "Removed global command"

    rm -f "$DESKTOP_FILE"
    echo -e "Removed Desktop entry"

    echo -e "${GREEN}Uninstalled successfully.${NC}"
}

header() {
    clear
    echo -e "${BOLD}========================================${NC}"
    echo -e "${BOLD}   üê± Nekoray Installer & Manager       ${NC}"
    echo -e "${BOLD}========================================${NC}"
    echo ""
}

show_menu() {
    header
    echo "Actions:"
    echo "  1) Install / Update Nekoray (Latest)"
    echo "  2) Uninstall Nekoray"
    echo "  0) Exit"
    echo ""
    echo -n "Choice: "
}

while true; do
    show_menu
    read choice
    
    case $choice in
        1)
            if [ "$EUID" -ne 0 ]; then
                echo -e "${BLUE}Elevating privileges for installation...${NC}"
                sudo bash "$0" --install-internal
                exit
            else
                install_nekoray
            fi
            read -p "Press Enter..."
            ;;
        2)
            if [ "$EUID" -ne 0 ]; then
                echo -e "${BLUE}Elevating privileges for uninstallation...${NC}"
                sudo bash "$0" --uninstall-internal
                exit
            else
                uninstall_nekoray
            fi
            read -p "Press Enter..."
            ;;
        0)
            exit 0
            ;;
        --install-internal)
            install_nekoray
            exit 0
            ;;
        --uninstall-internal)
            uninstall_nekoray
            exit 0
            ;;
        *)
            echo "Invalid choice."
            sleep 1
            ;;
    esac
done
