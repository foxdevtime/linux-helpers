#!/bin/bash

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

check_deps() {
    local missing=0
    for dep in ffmpeg fzf; do
        if ! command -v $dep &> /dev/null; then
            echo -e "${RED}[Error]${NC} Dependency '${BOLD}$dep${NC}' is missing."
            missing=1
        fi
    done

    if [ $missing -eq 1 ]; then
        echo -e "${YELLOW}Please install missing dependencies using your package manager.${NC}"
        echo "Examples:"
        echo "  Gentoo:  emerge app-shells/fzf media-video/ffmpeg"
        echo "  Debian:  apt install fzf ffmpeg"
        echo "  Arch:    pacman -S fzf ffmpeg"
        exit 1
    fi
}

get_input_file() {
    if [ -n "$1" ]; then
        if [ -f "$1" ]; then
            INPUT_FILE="$1"
        else
            echo -e "${RED}[Error]${NC} File '$1' not found."
            exit 1
        fi
    else
        echo -e "${BLUE}[?] Select input file:${NC}"
        INPUT_FILE=$(find . -maxdepth 1 -type f ! -name ".*" | fzf --height 40% --layout=reverse --border --prompt="File > ")
    fi

    if [ -z "$INPUT_FILE" ]; then
        echo "No file selected. Exiting."
        exit 0
    fi

    FILENAME=$(basename -- "$INPUT_FILE")
    NAME_NO_EXT="${FILENAME%.*}"
}

build_command() {
    echo -e "${BLUE}[?] Select Output Format:${NC}"
    FORMAT_SELECTION=$(echo -e "MP4 (Video)\nMKV (Video)\nWEBM (Web Video)\nMP3 (Audio Only)\nGIF (Animation)" | \
        fzf --height 20% --layout=reverse --border --prompt="Format > ")

    if [ -z "$FORMAT_SELECTION" ]; then exit 0; fi

    case "$FORMAT_SELECTION" in
        *"MP4"*) EXT="mp4"; V_CODEC_OPTS="libx264\nlibx265 (HEVC)";;
        *"MKV"*) EXT="mkv"; V_CODEC_OPTS="libx264\nlibx265 (HEVC)\ncopy (Stream Copy)";;
        *"WEBM"*) EXT="webm"; V_CODEC_OPTS="libvpx-vp9";;
        *"MP3"*) EXT="mp3"; TYPE="audio";;
        *"GIF"*) EXT="gif"; TYPE="image";;
    esac

    if [ "$TYPE" != "audio" ] && [ "$TYPE" != "image" ]; then
        echo -e "${BLUE}[?] Select Video Codec:${NC}"
        V_CODEC_SEL=$(echo -e "$V_CODEC_OPTS" | fzf --height 20% --layout=reverse --prompt="Codec > ")
        V_CODEC=$(echo "$V_CODEC_SEL" | awk '{print $1}')

        if [ "$V_CODEC" != "copy" ]; then
            echo -e "${BLUE}[?] Select Quality (CRF - Lower is better):${NC}"
            CRF_SEL=$(echo -e "18 (High Quality)\n23 (Balanced / Default)\n28 (Compressed)\nCustom" | \
                fzf --height 20% --layout=reverse --prompt="Quality > ")
            
            if [[ "$CRF_SEL" == *"Custom"* ]]; then
                read -p "Enter CRF value (0-51): " CRF
            else
                CRF=$(echo "$CRF_SEL" | awk '{print $1}')
            fi
            
            VIDEO_FLAGS="-c:v $V_CODEC -crf $CRF -preset medium"
        else
            VIDEO_FLAGS="-c:v copy"
        fi

        AUDIO_FLAGS="-c:a aac -b:a 128k"

        FINAL_CMD="ffmpeg -i \"$INPUT_FILE\" $VIDEO_FLAGS $AUDIO_FLAGS \"${NAME_NO_EXT}_processed.$EXT\""
    
    elif [ "$TYPE" == "audio" ]; then
        echo -e "${BLUE}[?] Select Bitrate:${NC}"
        BITRATE=$(echo -e "320k (High)\n192k (Good)\n128k (Standard)" | fzf --height 20% --layout=reverse | awk '{print $1}')
        FINAL_CMD="ffmpeg -i \"$INPUT_FILE\" -vn -c:a libmp3lame -b:a $BITRATE \"${NAME_NO_EXT}.$EXT\""
    
    elif [ "$TYPE" == "image" ]; then
        echo -e "${BLUE}[?] Select FPS:${NC}"
        FPS=$(echo -e "15\n30\n10" | fzf --height 20% --layout=reverse | awk '{print $1}')
        echo -e "${BLUE}[?] Select Width (Height auto):${NC}"
        WIDTH=$(echo -e "480\n720\n320\nOriginal" | fzf --height 20% --layout=reverse | awk '{print $1}')
        
        SCALE_FILTER=""
        if [ "$WIDTH" != "Original" ]; then
            SCALE_FILTER=",scale=$WIDTH:-1:flags=lanczos"
        fi

        FINAL_CMD="ffmpeg -i \"$INPUT_FILE\" -vf \"fps=$FPS$SCALE_FILTER\" \"${NAME_NO_EXT}.gif\""
    fi
}

check_deps
get_input_file "$1"
build_command

echo -e "\n${BOLD}Generated Command:${NC}"
echo -e "${YELLOW}$FINAL_CMD${NC}\n"

echo -e "${BLUE}[?] Execute command?${NC}"
CONFIRM=$(echo -e "Yes\nNo (Exit)" | fzf --height 20% --layout=reverse --prompt="Run? > ")

if [[ "$CONFIRM" == "Yes" ]]; then
    eval "$FINAL_CMD"
    echo -e "\n${GREEN}Done!${NC}"
else
    echo "Aborted."
fi
